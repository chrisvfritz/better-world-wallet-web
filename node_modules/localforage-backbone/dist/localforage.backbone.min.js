!function(a,b){if("function"==typeof define&&define.amd)define(["localforage","backbone","underscore"],b);else if("undefined"!=typeof module&&module.exports){var c=require("localforage"),d=require("backbone"),e=require("underscore");module.exports=b(c,d,e)}else b(a.localforage,a.Backbone,a._)}(this,function(a,b,c){function d(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function e(){return d()+d()+"-"+d()+"-"+d()+"-"+d()+"-"+d()+d()+d()}function f(b,d,e,f){if(b){var h=b.map(function(a){return b.model.prototype.sync._localforageNamespace+"/"+a.id});d=d?c.partial(d,e,f):void 0,b.sync.localforageKey||g(b),a.setItem(b.sync.localforageKey,h,d)}}function g(a){a instanceof b.Collection?a.sync.localforageKey=a.sync._localforageNamespace:(a.id||(a[a.idAttribute]=a.attributes[a.idAttribute]=e()),a.sync.localforageKey=a.sync._localforageNamespace+"/"+a.id)}return b.localforage={localforageInstance:a,sync:function(a){var b=this,c=function(a,c,d){switch(g(c),a){case"read":return c.id?b.find(c,d):b.findAll(c,d);case"create":return b.create(c,d);case"update":return b.update(c,d);case"delete":return b.destroy(c,d)}};return c._localforageNamespace=a,c._localeForageKeyFn=g,c},save:function(b,c){a.setItem(b.sync.localforageKey,b.toJSON(),function(a,d){b.collection?f(b.collection,c,a,d):c&&c(d)})},create:function(a,b){return this.update(a,b)},update:function(a,b){this.save(a,function(a){b.success&&b.success(a)})},find:function(b,d){a.getItem(b.sync.localforageKey,function(a,b){a||c.isEmpty(b)?d.error&&d.error():d.success&&d.success(b)})},findAll:function(b,d){a.getItem(b.sync.localforageKey,function(b,e){if(!b&&e&&e.length){var f=function(){d.success&&d.success(e)};f=c.after(e.length,f);for(var g=function(a,b,c){e[a]=c,f()},h=0;h<e.length;++h)a.getItem(e[h],c.partial(g,h))}else e=[],d.success&&d.success(e)})},destroy:function(b,c){var d=b.collection;a.removeItem(b.sync.localforageKey,function(){d?f(d,c.success,null,b.toJSON()):c.success&&c.success(b.toJSON())})}},b.localforage});